<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Coins ‚Äì Bronze / Silver / Gold</title>
<style>
  :root { --bg:#0f1220; --card:#181c2f; --ink:#eef1ff; --muted:#9aa3c7; --accent:#6ca8ff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--ink); }
  header, footer { padding:12px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
  header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
  .wrap { max-width:1000px; margin:0 auto; padding:16px; display:grid; grid-template-columns:360px 1fr; gap:16px; }
  .card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 0 0 1px rgba(255,255,255,.05) inset; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label { font-size:13px; color:var(--muted); }
  input, select, textarea, button { background:#12162a; border:1px solid #2a3052; color:var(--ink); padding:8px 10px; border-radius:8px; }
  input[type="number"] { width:90px; }
  button { cursor:pointer; }
  button.primary { background:linear-gradient(180deg,#2f67ff,#2149c8); border:none; }
  .grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
  .day { aspect-ratio:1/1; background:#12162a; border:1px solid #2a3052; border-radius:10px; padding:8px; position:relative; display:flex; flex-direction:column; justify-content:space-between; }
  .day .dnum { font-size:12px; color:var(--muted); }
  .coin { font-size:22px; text-align:right; }
  .ghost { opacity:.35 }
  .summary { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px; }
  .pill { background:#12162a; border:1px solid #2a3052; border-radius:999px; padding:10px 12px; display:flex; align-items:center; justify-content:center; gap:8px; }
  .stat { font-size:13px; color:var(--muted); }
  .big { font-size:28px; font-weight:700; }
  .muted { color:var(--muted); }
  /* Day-task row: label | minutes | percent */
  .taskrow { display:grid; grid-template-columns:1fr 90px 90px; gap:8px; align-items:center; margin-bottom:6px; }
  .taskrow span { font-size:13px; }
  .sep { height:1px; background:#2a3052; margin:10px 0; opacity:.6 }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .note { width:100%; min-height:70px; }
  .kicker { font-size:12px; color:var(--muted); margin-top:-6px; }
  .linkish { color:var(--accent); text-decoration:underline; cursor:pointer; }
  .center { text-align:center; }
  .right { text-align:right; }
  .hidden { display:none; }
  /* Config task row: name | id | weight | target minutes */
  .taskcfgrow { display:grid; grid-template-columns:1fr 140px 90px 120px; gap:8px; align-items:center; margin-bottom:6px; }
</style>
</head>
<body>
<header>
  <h1>Daily Coins</h1>
  <div class="row">
    <button id="exportBtn">Export JSON</button>
    <label class="linkish">
      Import JSON
      <input id="importFile" type="file" accept="application/json" class="hidden" />
    </label>
  </div>
</header>

<div class="wrap">
  <!-- Left: Day editor -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <label>Date</label><br/>
        <input type="date" id="datePick" />
      </div>
      <div>
        <label>Month</label><br/>
        <input type="month" id="monthPick" />
      </div>
    </div>

    <div class="sep"></div>

    <div>
      <label>Tasks for today</label>
      <div id="taskList"></div>
      <div class="kicker">
        Enter <b>minutes</b> (auto-converts to %) or enter % directly. We compare to each task‚Äôs <b>target minutes</b>.
        Hitting 100% of targets ‚Üí high efficiency ‚Üí ü•á by thresholds.
      </div>
    </div>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between">
      <div>
        <label>Auto-computed</label>
        <div class="row">
          <div class="pill"><span>Efficiency:</span> <b id="effOut">0%</b></div>
          <div class="pill"><span>Coin:</span> <span id="coinOut" style="font-size:20px">‚Äì</span></div>
        </div>
      </div>
      <div class="row">
        <button id="saveBtn" class="primary">Save Day</button>
        <button id="deleteBtn" title="Clear this day">Clear</button>
      </div>
    </div>

    <div class="sep"></div>

    <label>Notes</label>
    <textarea id="note" class="note" placeholder="Optional note for the day‚Ä¶"></textarea>

    <div class="sep"></div>

    <details>
      <summary>‚öôÔ∏è Configure (tasks, weights, thresholds)</summary>
      <div class="kicker">Weights should sum ‚âà 1.0 (we normalize if not). Set a daily <b>target minutes</b> for each task.</div>
      <div class="row muted" style="gap:16px;margin:6px 0 4px 0;">
        <span style="width:100%;font-size:12px">Columns: Name | ID | Weight (0‚Äì1) | Target minutes</span>
      </div>
      <div id="cfgTasks"></div>
      <button id="addTaskBtn">+ Add Task</button>
      <div class="sep"></div>
      <div class="row">
        <label>Bronze max %</label><input id="thBronze" type="number" min="0" max="100" value="59" />
        <label>Silver max %</label><input id="thSilver" type="number" min="0" max="100" value="84" />
        <label>Gold starts at</label><input id="thGold" type="number" min="0" max="100" value="85" />
        <button id="saveCfgBtn">Save Config</button>
      </div>
    </details>
  </section>

  <!-- Right: Month view -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevMonth">‚óÄ</button>
        <div id="monthTitle" style="font-weight:700"></div>
        <button id="nextMonth">‚ñ∂</button>
      </div>
      <div class="row">
        <div class="pill"><span>ü•â</span><b id="cBronze">0</b></div>
        <div class="pill"><span>ü•à</span><b id="cSilver">0</b></div>
        <div class="pill"><span>ü•á</span><b id="cGold">0</b></div>
      </div>
    </div>

    <div class="grid" id="calGrid"></div>

    <div class="sep"></div>

    <div class="summary">
      <div class="card">
        <div class="stat">Monthly Average Points</div>
        <div class="big" id="avgPts">0.00</div>
      </div>
      <div class="card">
        <div class="stat">Longest Streak (‚â•Silver)</div>
        <div class="big" id="streak">0</div>
      </div>
      <div class="card center">
        <div class="stat">Overall Month</div>
        <div class="big" id="monthCoin">‚Äì</div>
        <div class="muted" id="monthExplain"></div>
      </div>
    </div>

  </section>
</div>

<footer class="muted">
  <div>Tip: tap a day in the calendar to edit; export regularly for backup.</div>
  <div class="right">Made for ü•â/ü•à/ü•á habit tracking</div>
</footer>

<script>
/* ================== CONFIG ================== */
// Now each task has a daily time target in minutes.
const DEFAULT_TASKS = [
  { id: "study",    name: "Study / Deep Work", weight: 0.4, target: 120 },
  { id: "practice", name: "Math Practice",     weight: 0.2, target: 60  },
  { id: "reinforce",name: "Day Reinforcing",   weight: 0.2, target: 45  },
  { id: "recall",   name: "Night Recall",      weight: 0.2, target: 20  },
];
// Thresholds remain global and apply to the final (weighted) efficiency %
const DEFAULT_THRESHOLDS = { BRONZE_MAX: 59, SILVER_MAX: 84, GOLD_MIN: 85 };

const PTS   = { bronze:1, silver:2, gold:3 };
const EMOJI = { bronze:"ü•â", silver:"ü•à", gold:"ü•á" };

/* ================== STATE & STORAGE ================== */
const SKEY  = "dailyCoins.v1";
const SKCFG = "dailyCoinsCfg.v1"; // tasks + thresholds

let cfg = loadCfg();
let store = loadStore();

function loadCfg(){
  const c = localStorage.getItem(SKCFG);
  if (c) {
    const obj = JSON.parse(c);
    // Back-compat: seed 'target' if missing
    obj.tasks = obj.tasks.map(t => ({ target: 60, ...t }));
    return obj;
  }
  const seeded = { tasks: DEFAULT_TASKS, thresholds: DEFAULT_THRESHOLDS };
  localStorage.setItem(SKCFG, JSON.stringify(seeded));
  return seeded;
}
function saveCfg(){ localStorage.setItem(SKCFG, JSON.stringify(cfg)); }

function loadStore(){
  const s = localStorage.getItem(SKEY);
  if (s) return JSON.parse(s);
  const seeded = { days: {} }; // key: YYYY-MM-DD -> { eff, coin, note, tasks:{id:percent}, mins:{id:minutes} }
  localStorage.setItem(SKEY, JSON.stringify(seeded));
  return seeded;
}
function saveStore(){ localStorage.setItem(SKEY, JSON.stringify(store)); }

/* ================== HELPERS ================== */
const $ = (q) => document.querySelector(q);
const fmt2 = (n) => (Math.round(n*100)/100).toFixed(2);
function ymd(d){ return d.toISOString().slice(0,10); }
function ym(d){ return d.toISOString().slice(0,7); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function normalizeWeights(tasks){
  const sum = tasks.reduce((a,t)=>a+(+t.weight||0),0) || 1;
  return tasks.map(t => ({...t, weight: (+t.weight||0)/sum }));
}

function coinForEff(eff){
  const { BRONZE_MAX, SILVER_MAX, GOLD_MIN } = cfg.thresholds;
  if (eff >= GOLD_MIN) return "gold";
  if (eff <= BRONZE_MAX) return "bronze";
  return "silver";
}

function weightedEfficiency(taskPercents){ // object: id -> 0..100
  const tasks = normalizeWeights(cfg.tasks);
  let acc = 0;
  for (const t of tasks){
    const p = clamp(+taskPercents[t.id] || 0, 0, 100);
    acc += (p/100) * t.weight * 100; // keep as %
  }
  return clamp(acc, 0, 100);
}

/* ================== UI BINDINGS ================== */
const datePick   = $("#datePick");
const monthPick  = $("#monthPick");
const taskList   = $("#taskList");
const effOut     = $("#effOut");
const coinOut    = $("#coinOut");
const note       = $("#note");
const saveBtn    = $("#saveBtn");
const delBtn     = $("#deleteBtn");
const calGrid    = $("#calGrid");
const monthTitle = $("#monthTitle");
const prevMonthBtn = $("#prevMonth");
const nextMonthBtn = $("#nextMonth");
const cBronze    = $("#cBronze");
const cSilver    = $("#cSilver");
const cGold      = $("#cGold");
const avgPts     = $("#avgPts");
const streakEl   = $("#streak");
const monthCoin  = $("#monthCoin");
const monthExplain = $("#monthExplain");
const exportBtn  = $("#exportBtn");
const importFile = $("#importFile");

const thBronze = $("#thBronze");
const thSilver = $("#thSilver");
const thGold   = $("#thGold");
const cfgTasks = $("#cfgTasks");
const addTaskBtn = $("#addTaskBtn");
const saveCfgBtn = $("#saveCfgBtn");

/* ================== INIT ================== */
(function init(){
  const today = new Date();
  datePick.value = ymd(today);
  monthPick.value = ym(today);
  renderTasksForDay();
  renderCfg();
  rerunAuto();
  renderCalendar();
})();

/* ================== DAY FORM ================== */
function renderTasksForDay(){
  taskList.innerHTML = "";
  const dayKey = datePick.value;
  const day = store.days[dayKey] || { tasks:{}, mins:{} };
  note.value = day.note || "";

  for (const t of cfg.tasks){
    const percVal = day.tasks?.[t.id] ?? "";
    const minsVal = day.mins?.[t.id] ?? "";
    const row = document.createElement("div");
    row.className = "taskrow";
    row.innerHTML = `
      <span>${t.name} <span class="muted">(${fmt2(t.weight*100)}%) ‚Ä¢ target ${t.target||0}m</span></span>
      <input type="number" min="0" value="${minsVal}" data-task="${t.id}" data-kind="mins" placeholder="min" />
      <input type="number" min="0" max="100" value="${percVal}" data-task="${t.id}" data-kind="perc" placeholder="%" />
    `;
    taskList.appendChild(row);
  }

  // listeners
  taskList.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", (e)=>onTaskInput(e.target));
  });
}

function onTaskInput(el){
  const id   = el.dataset.task;
  const kind = el.dataset.kind;
  const row  = el.closest(".taskrow");
  const minsInp = row.querySelector('input[data-kind="mins"]');
  const percInp = row.querySelector('input[data-kind="perc"]');
  const t = cfg.tasks.find(x=>x.id===id) || { target:0 };
  const target = +t.target || 0;

  if (kind === "mins"){
    const mins = +minsInp.value || 0;
    const perc = target ? clamp((mins/target)*100, 0, 100) : 0;
    percInp.value = Math.round(perc);
  } else {
    const perc = clamp(+percInp.value || 0, 0, 100);
    const mins = target ? Math.round((perc/100)*target) : 0;
    minsInp.value = mins || "";
  }
  rerunAuto();
}

function gatherTaskData(){
  const perc = {};
  const mins = {};
  taskList.querySelectorAll(".taskrow").forEach(row=>{
    const id    = row.querySelector('input[data-kind="perc"]').dataset.task;
    const pVal  = +row.querySelector('input[data-kind="perc"]').value || 0;
    const mVal  = +row.querySelector('input[data-kind="mins"]').value || 0;
    perc[id] = pVal;
    if (mVal>0) mins[id] = mVal;
  });
  return { perc, mins };
}

function rerunAuto(){
  const { perc } = gatherTaskData();
  const eff = weightedEfficiency(perc);
  effOut.textContent = fmt2(eff) + "%";
  coinOut.textContent = isNaN(eff) ? "‚Äì" : EMOJI[coinForEff(eff)];
}

saveBtn.addEventListener("click", ()=>{
  const key = datePick.value;
  if (!key) return;
  const { perc, mins } = gatherTaskData();
  const eff = weightedEfficiency(perc);
  const coin = coinForEff(eff);
  store.days[key] = { eff, coin, note: note.value, tasks: perc, mins: mins };
  saveStore();
  renderCalendar();
});

delBtn.addEventListener("click", ()=>{
  const key = datePick.value;
  delete store.days[key];
  saveStore();
  renderTasksForDay();
  rerunAuto();
  renderCalendar();
});

/* ================== CALENDAR / MONTH SUMMARY ================== */
function monthMeta(ymStr){
  const [Y,M] = ymStr.split("-").map(Number);
  const first = new Date(Y, M-1, 1);
  const startW = first.getDay(); // 0 Sun .. 6 Sat
  const days = new Date(Y, M, 0).getDate();
  return { Y, M, first, startW, days };
}

function renderCalendar(){
  const mval = monthPick.value;
  const { Y, M, startW, days } = monthMeta(mval);
  monthTitle.textContent = new Date(Y, M-1).toLocaleString(undefined, { month:"long", year:"numeric" });

  calGrid.innerHTML = "";
  for (let i=0;i<startW;i++){
    const d = document.createElement("div");
    d.className = "day ghost";
    calGrid.appendChild(d);
  }
  for (let d=1; d<=days; d++){
    const key = `${mval}-${String(d).padStart(2,"0")}`;
    const info = store.days[key];
    const el = document.createElement("div");
    el.className = "day";
    el.innerHTML = `
      <div class="dnum">${d}</div>
      <div class="coin">${info ? EMOJI[info.coin] : "¬∑"}</div>
    `;
    el.addEventListener("click", ()=>{
      datePick.value = key;
      renderTasksForDay();
      rerunAuto();
      window.scrollTo({ top:0, behavior:"smooth" });
    });
    calGrid.appendChild(el);
  }

  // counts and stats
  let b=0,s=0,g=0, ptsSum=0, n=0;
  let bestStreak = 0, cur = 0;
  for (let d=1; d<=days; d++){
    const key = `${mval}-${String(d).padStart(2,"0")}`;
    const info = store.days[key];
    if (!info) { cur = 0; continue; }
    if (info.coin==="bronze") b++;
    if (info.coin==="silver") s++;
    if (info.coin==="gold")   g++;
    ptsSum += PTS[info.coin]; n++;

    if (info.coin==="silver" || info.coin==="gold") { cur++; bestStreak = Math.max(bestStreak, cur); }
    else cur = 0;
  }
  $("#cBronze").textContent = b;
  $("#cSilver").textContent = s;
  $("#cGold").textContent   = g;

  const avg = n ? (ptsSum/n) : 0;
  avgPts.textContent = fmt2(avg);
  streakEl.textContent = bestStreak;

  let monthResult = null, explain = "";
  const maxCount = Math.max(b,s,g);
  const winners = [];
  if (b===maxCount) winners.push("bronze");
  if (s===maxCount) winners.push("silver");
  if (g===maxCount) winners.push("gold");
  if (winners.length===1) {
    monthResult = winners[0];
    explain = "Dominant coin by count.";
  } else {
    if (avg >= 2.5) monthResult = "gold";
    else if (avg >= 1.75) monthResult = "silver";
    else monthResult = "bronze";
    explain = "Tie ‚Üí resolved by average points.";
  }
  monthCoin.textContent = n ? EMOJI[monthResult] : "‚Äì";
  monthExplain.textContent = n ? explain : "No data this month.";
}

prevMonthBtn.addEventListener("click", ()=>{
  const { Y, M } = monthMeta(monthPick.value);
  const prev = new Date(Y, M-2, 1);
  monthPick.value = ym(prev);
  renderCalendar();
});
nextMonthBtn.addEventListener("click", ()=>{
  const { Y, M } = monthMeta(monthPick.value);
  const next = new Date(Y, M, 1);
  monthPick.value = ym(next);
  renderCalendar();
});
monthPick.addEventListener("input", renderCalendar);
datePick.addEventListener("input", ()=>{ renderTasksForDay(); rerunAuto(); });

/* ================== CONFIG UI ================== */
function renderCfg(){
  thBronze.value = cfg.thresholds.BRONZE_MAX;
  thSilver.value = cfg.thresholds.SILVER_MAX;
  thGold.value   = cfg.thresholds.GOLD_MIN;

  cfgTasks.innerHTML = "";
  for (const t of cfg.tasks){
    const row = document.createElement("div");
    row.className = "taskcfgrow";
    row.innerHTML = `
      <input type="text" value="${t.name}" data-id="${t.id}" data-k="name" placeholder="name"/>
      <input type="text" value="${t.id}" data-id="${t.id}" data-k="id" placeholder="id"/>
      <input type="number" step="0.05" value="${t.weight}" data-id="${t.id}" data-k="weight" placeholder="weight (0-1)"/>
      <input type="number" step="5" value="${t.target||60}" data-id="${t.id}" data-k="target" placeholder="target min"/>
    `;
    cfgTasks.appendChild(row);
  }

  cfgTasks.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const id = e.target.dataset.id;
      const k  = e.target.dataset.k;
      const v  = e.target.value;
      const idx = cfg.tasks.findIndex(x=>x.id===id);
      if (idx>=0){
        if (k==="weight") cfg.tasks[idx][k] = +v;
        else if (k==="target") cfg.tasks[idx][k] = Math.max(0, +v|0);
        else cfg.tasks[idx][k] = v;
      }
    });
  });
}
addTaskBtn.addEventListener("click", ()=>{
  const newid = "task"+Math.random().toString(36).slice(2,7);
  cfg.tasks.push({ id:newid, name:"New Task", weight:0.1, target:60 });
  renderCfg();
});
saveCfgBtn.addEventListener("click", ()=>{
  const b = +thBronze.value, s = +thSilver.value, g = +thGold.value;
  cfg.thresholds = {
    BRONZE_MAX: clamp(b,0,98),
    SILVER_MAX: clamp(s, Math.max(b+1,1), 99),
    GOLD_MIN:   clamp(g, Math.max(s+1,2), 100)
  };
  cfg.tasks = normalizeWeights(cfg.tasks);
  saveCfg();
  renderTasksForDay();
  rerunAuto();
  renderCalendar();
});

/* ================== IMPORT / EXPORT ================== */
exportBtn.addEventListener("click", ()=>{
  const payload = { cfg, store };
  const blob = new Blob([JSON.stringify(payload,null,2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "daily-coins-backup.json"; a.click();
  URL.revokeObjectURL(url);
});
document.querySelector("label input#importFile").addEventListener("change", (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    try {
      const data = JSON.parse(r.result);
      if (data.cfg) cfg = {
        thresholds: DEFAULT_THRESHOLDS, tasks: DEFAULT_TASKS, ...data.cfg,
        tasks: (data.cfg.tasks || DEFAULT_TASKS).map(t=>({ target:60, ...t }))
      };
      if (data.store) store = data.store;
      saveCfg(); saveStore();
      renderCfg(); renderTasksForDay(); rerunAuto(); renderCalendar();
      alert("Imported successfully.");
    } catch(err){ alert("Invalid JSON file."); }
  };
  r.readAsText(f);
});
</script>
</body>
</html>
